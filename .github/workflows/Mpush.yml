name: Mpush
on:
  workflow_dispatch:
    inputs:
      pan123:
        description: '123盘'
        default: 'true'
        required: true
        type: boolean
      OneDrive:
        description: 'OneDrive'
        default: 'true'
        required: true
        type: boolean
      GithubRelease:
        description: 'Github Release'
        default: 'true'
        required: true
        type: boolean
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1.准备环境
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          if [ -n "${{ github.event.inputs.custom_version }}" ]; then
              echo "date=${{ github.event.inputs.custom_version }}" >> $GITHUB_ENV
          else
              echo "date=$(echo ${{ github.event.inputs.URL }} | cut -d"/" -f4)" >> $GITHUB_ENV
          fi
          echo "device=lmi" >> $GITHUB_ENV
          echo "ORIGN_ZIP_NAME=$(echo ${{ github.event.inputs.Bottom_URL }} | cut -d"/" -f5)" >> $GITHUB_ENV
          sudo apt install python3 python3-pip aria2 zip p7zip-full tar zipalign zstd dos2unix
          sudo apt --fix-broken install
          sudo apt update --fix-missing
          pip3 install --upgrade pip
          pip3 install pycryptodome
          pip3 install setuptools
          pip3 install docopt
          pip3 install requests
          pip3 install beautifulsoup4
          pip3 install --ignore-installed pyyaml
      - name: 2.发送开始构建通知
        run: |
          if [[ "${{ env.device }}" == "lmi" ]]; then
              curl -i -X POST -H 'Content-type':'application/json' -d '{"token":"${{ secrets.appToken2 }}","title":"红米K30Pro ${{ env.date }}开始构建","content":" **红米K30Pro ${{ env.date }}开始构建** ","topic":"lmi","template":"markdown"}' http://www.pushplus.plus/send || true
          fi
      - name: 8.发送打包成功通知
        run: |
          mkdir "$GITHUB_WORKSPACE"/romdata && touch "$GITHUB_WORKSPACE"/romdata/${{ env.device }}.ini
          echo ${{ env.device }}PKG=${{ env.NEW_PACKAGE_NAME }} >> "$GITHUB_WORKSPACE"/romdata/${{ env.device }}.ini
          echo ${{ env.device }}MD5=${{ env.MD5 }} >> "$GITHUB_WORKSPACE"/romdata/${{ env.device }}.ini
          echo ${{ env.device }}TIME=\"$(TZ=':Asia/Shanghai' date '+%Y.%m.%d %H:%M')\" >> "$GITHUB_WORKSPACE"/romdata/${{ env.device }}.ini
          if [[ "${{ env.device }}" == "lmi" ]]; then
              Mpush=" **红米K30Pro ${{ env.date }}已构建完成** \n \n"
              if [[ "${{ env.popup }}" == "true" ]]; then
                  Mpush+=" **升降未修复，当前为测试包** \n \n"
              fi
              Mpush+=" **包名：${{ env.NEW_PACKAGE_NAME }}** \n \n **MD5：${{ env.MD5 }}** \n \n"
              if [[ ${{ github.event.inputs.GithubRelease }} == 'true' ]]; then
                 Mpush+=" **上传至GithubRelease，请前往Github自行下载** \n \n"
              fi
              if [[ ${{ github.event.inputs.OneDrive }} == 'true' ]]; then
                 Mpush+=" **下载地址为：[https://onedrive.zjw.js.cn/RubbishBin/DevPackages/${{ env.NEW_PACKAGE_NAME }}](https://onedrive.zjw.js.cn/RubbishBin/DevPackages/${{ env.NEW_PACKAGE_NAME }})**"
              fi
              if [[ ${{ github.event.inputs.pan123 }} == 'true' ]]; then
                 Mpush+=" **上传至123云盘，请登录123云盘自行下载** \n \n"
              fi
              echo "Mpush=$(echo $Mpush)" >> $GITHUB_ENV
              curl -i -X POST -H 'Content-type':'application/json' -d '{"token":"${{ secrets.appToken2 }}","title":"红米K30Pro ${{ env.date }}已构建完成","content":"${{ env.Mpush }}","topic":"lmi","template":"markdown"}' http://www.pushplus.plus/send || true
              echo ${{ env.device }}URL=https://onedrive.zjw.js.cn/RubbishBin/DevPackages/${{ env.NEW_PACKAGE_NAME }} >> "$GITHUB_WORKSPACE"/romdata/${{ env.device }}.ini
          fi
      - name: 9.删除工作流运行
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0
